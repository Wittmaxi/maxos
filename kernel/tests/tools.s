;-------------------------------------------------;
; Copyright 2023 Maximilian Wittmer               ;
;-( synopsis )------------------------------------;
; TST_panicRMode                                  ;
; TST_assertEqual                                 ;
; TST_rmodeDiag                                   ;
;-------------------------------------------------;
                                                  ;
;-------------------------------------------------;
; panics for failed unit tests                    ;
;-------------------------------------------------;
TST_panicRMode MACRO                              ;
    MOV ax, 90                                    ;
    CALL RM_panic                                 ;
ENDM                                              ;
                                                  ;
;-------------------------------------------------;
; TST_rmodeDiag                                   ;
;-------------------------------------------------;
; Prints the diagnostics - panics if a test failed;
;-------------------------------------------------;
TST_rmodeDiag PROC                                ;
    ;- total tests: print                         ;
    MOV si, OFFSET TST_rmodeTotalTests            ;
    CALL DPT_printStr                             ;
    MOV ax, WORD PTR [TST_testsPerformed]         ;
    CALL DPT_printNum                             ;
    ;- total fails: print                         ;
    MOV si, OFFSET TST_remodeTotalFail            ;
    CALL DPT_printStr                             ;
    MOV ax, WORD PTR [TST_testsFailed]            ;
    CALL DPT_printNum                             ;
    CALL DPT_newLine                              ;
    ;- panic if a test failed                     ;
    MOV ax, WORD PTR [TST_testsFailed]            ;
    OR ax, ax                                     ;
    JZ @@noFail                                   ;
    TST_panicRMode                                ;
@@noFail:                                         ;
    RET                                           ;
TST_rmodeDiag ENDP                                ;
    TST_rmodeTotalTests DB 13, 10, "    unit tests ran: ", 0
    TST_remodeTotalFail DB " failed: ", 0         ;
                                                  ;
;-------------------------------------------------;
; TST_assertEqual                                 ;
;-------------------------------------------------;
; asserts that two operands are equal             ;
; counts how many unit tests were performed and   ;
; counts how many failed                          ;
;-( inputs )--------------------------------------;
; BP + 2 = op 1                                   ;
; BP + 4 = op 2                                   ;
; BP + 6 = PTR to string error message            ;
;-------------------------------------------------;
TST_assertEqual PROC                              ;
    ENTER 0, 0                                    ;
    ;- params                                     ;
    OP1 EQU BP + 2                                ;
    OP2 EQU BP + 4                                ;
    ERROR EQU BP + 6                              ;
    ;- count performed unit tests                 ;
    INC WORD PTR [TST_testsPerformed]             ;
    ;- compare operands                           ;
    MOV ax, WORD PTR [OP1]                        ;
    CMP ax, WORD PTR [OP2]                        ;
    JE @@noFail                                   ;
    ;- failed! increase fail count                ;
    INC WORD PTR [TST_testsFailed]                ;
    ;-- display error message                     ;
    MOV si, WORD PTR [ERROR]                      ;
    CALL DPT_printStr                             ;
@@noFail:                                         ;
    RET 4                                         ;
TST_assertEqual ENDP                              ;
                                                  ;
    TST_testsPerformed DW 0                       ;
    TST_testsFailed DW 0                          ;
